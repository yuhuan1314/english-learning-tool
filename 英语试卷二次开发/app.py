# å¯¼å…¥ä¾èµ–ï¼ˆç”¨å®˜æ–¹æ­£ç‰ˆSDKï¼Œå½»åº•è§£å†³ç‰ˆæœ¬å…¼å®¹é—®é¢˜ï¼‰
import streamlit as st
from minimax import MiniMax

# -------------------------- ã€ä½ åªéœ€è¦æ”¹è¿™é‡Œçš„3ä¸ªä¿¡æ¯ï¼Œå…¶ä»–æ‰€æœ‰ä»£ç éƒ½ä¸ç”¨åŠ¨ã€‘ --------------------------
YOUR_MINIMAX_API_KEY = "sk-cp-3yV1Tg4PVX98E-lu p5R4UShPvzzO0uZNBcXGj SYIJIIFD3fg40LneOSB9KGo TX4EkwYKyPZ9AapQwF991 5SVu65A9OMX5c7ViYo8iy7 pSHAiihLQ8xW73sw"
YOUR_MINIMAX_GROUP_ID = "2024308105302516508"
MINIMAX_MODEL_ID = "abab6.5-chat" # å®˜æ–¹æ ‡å‡†æ¨¡å‹åï¼Œä¸è¦ä¹±æ”¹
# -----------------------------------------------------------------------------------------------------

# Streamlité¡µé¢åŸºç¡€é…ç½®ï¼ˆå’Œä½ åŸæ¥çš„é¡µé¢ä¿æŒä¸€è‡´ï¼‰
st.set_page_config(page_title="è‹±è¯­å­¦ä¹ å·¥å…·", page_icon="ğŸ“š", layout="wide")
st.title("ğŸ“š è‹±è¯­å­¦ä¹ å·¥å…·")
st.divider()

# -------------------------- ã€æ ¸å¿ƒä¿®å¤1ï¼šå½»åº•è§£å†³group_idåˆå§‹åŒ–æŠ¥é”™ã€‘ --------------------------
# åˆå§‹åŒ–MiniMaxå®¢æˆ·ç«¯ï¼ˆåªä¼ api_keyï¼Œç»å¯¹ä¸ä¼ group_idï¼Œç”¨ç¼“å­˜é¿å…é‡å¤åˆå§‹åŒ–ï¼‰
@st.cache_resource
def init_minimax_client():
    try:
        client = MiniMax(api_key=YOUR_MINIMAX_API_KEY)
        st.success("âœ… æ¨¡å‹å®¢æˆ·ç«¯åˆå§‹åŒ–æˆåŠŸï¼Œæ— æŠ¥é”™")
        return client
    except Exception as e:
        st.error(f"âŒ å®¢æˆ·ç«¯åˆå§‹åŒ–å¤±è´¥ï¼š{e}")
        st.stop()

# å…¨å±€åˆå§‹åŒ–å®¢æˆ·ç«¯ï¼Œæ•´ä¸ªé¡µé¢åªä¼šæ‰§è¡Œä¸€æ¬¡
minimax_client = init_minimax_client()

# -------------------------- ã€æ ¸å¿ƒä¿®å¤2ï¼šå°è£…é€šç”¨è°ƒç”¨å‡½æ•°ï¼Œå½»åº•è§£å†³æ¥å£è§£ææŠ¥é”™ã€‘ --------------------------
# ä¸‰ä¸ªæŒ‰é’®å…±ç”¨è¿™ä¸ªå‡½æ•°ï¼Œä¸ç”¨é‡å¤å†™ä»£ç ï¼Œè‡ªå¸¦é”™è¯¯æ•è·+æ ¼å¼æ ¡éªŒ
def call_minimax_llm(system_prompt, user_input):
    # å…ˆæ ¡éªŒè¾“å…¥å†…å®¹ä¸ä¸ºç©º
    if not user_input.strip():
        st.warning("è¯·å…ˆè¾“å…¥è¦å¤„ç†çš„è‹±è¯­å†…å®¹ï¼Œå†ç‚¹å‡»æŒ‰é’®ï¼")
        return None
    
    # æ ‡å‡†æ¥å£æ ¼å¼ï¼Œç»å¯¹ä¸ä¼šå‡ºç°æ ¼å¼é”™è¯¯
    messages = [
        {"role": "system", "content": system_prompt},
        {"role": "user", "content": user_input}
    ]

    try:
        # ã€æ ¸å¿ƒä¿®å¤ã€‘group_idåªåœ¨è°ƒç”¨æ¥å£æ—¶ä¼ ï¼Œç»å¯¹ä¸åœ¨åˆå§‹åŒ–æ—¶ä¼ 
        response = minimax_client.chat.completions.create(
            model=MINIMAX_MODEL_ID,
            group_id=YOUR_MINIMAX_GROUP_ID,
            messages=messages,
            temperature=0.7,
            max_tokens=1024,
            timeout=30  # åŠ è¶…æ—¶ï¼Œé¿å…ç½‘ç»œé—®é¢˜å¯¼è‡´è§£æå´©æºƒ
        )
        # æå–è¿”å›ç»“æœï¼Œæ ¼å¼å®Œå…¨åŒ¹é…å®˜æ–¹SDK
        return response.choices[0].message.content
    
    except Exception as e:
        # æŠŠåº•å±‚é”™è¯¯ç›´æ¥å±•ç¤ºåœ¨é¡µé¢ä¸Šï¼Œä¸ç”¨å»ç»ˆç«¯çœ‹
        st.error(f"âŒ è°ƒç”¨æ¨¡å‹å¤±è´¥ï¼Œé”™è¯¯åŸå› ï¼š{e}")
        print("å®Œæ•´æŠ¥é”™æ—¥å¿—ï¼š", e)
        return None

# -------------------------- ã€è¿™é‡Œå°±æ˜¯ä½ è¦çš„3ä¸ªæŒ‰é’®ï¼ŒåŠŸèƒ½å®Œå…¨ä¿ç•™ï¼Œå¯ä¸€é”®ä¿®æ”¹ã€‘ --------------------------
# è¾“å…¥æ¡†ï¼ˆå’Œä½ åŸæ¥çš„é€»è¾‘ä¸€è‡´ï¼Œå…ˆè¾“å…¥å†…å®¹ï¼Œå†ç‚¹æŒ‰é’®ï¼‰
user_input = st.text_area(
    "è¯·è¾“å…¥ä½ è¦å¤„ç†çš„è‹±è¯­å†…å®¹ï¼š",
    height=150,
    placeholder="æ¯”å¦‚ï¼šè¾“å…¥è‹±è¯­å¥å­/æ–‡ç« /å•è¯ï¼Œç‚¹å‡»ä¸‹æ–¹å¯¹åº”æŒ‰é’®å³å¯å¤„ç†"
)

# 3ä¸ªæŒ‰é’®å¹¶æ’å¸ƒå±€ï¼ˆå’Œä½ åŸæ¥çš„â€œä¸‰çº½æ‰£â€å®Œå…¨ä¸€è‡´ï¼‰
col1, col2, col3 = st.columns(3)

# æŒ‰é’®1ï¼šé»˜è®¤åŠŸèƒ½ã€ä¸­è‹±äº’è¯‘ã€‘ï¼Œä½ å¯ä»¥æ”¹æˆè‡ªå·±åŸæ¥çš„åŠŸèƒ½
with col1:
    btn_translate = st.button("ğŸŒ ä¸­è‹±äº’è¯‘", type="primary", use_container_width=True)

# æŒ‰é’®2ï¼šé»˜è®¤åŠŸèƒ½ã€è¯­æ³•çº é”™+è®²è§£ã€‘ï¼Œä½ å¯ä»¥æ”¹æˆè‡ªå·±åŸæ¥çš„åŠŸèƒ½
with col2:
    btn_grammar = st.button("ğŸ“ è¯­æ³•çº é”™è®²è§£", type="primary", use_container_width=True)

# æŒ‰é’®3ï¼šé»˜è®¤åŠŸèƒ½ã€å•è¯/çŸ­è¯­è§£æã€‘ï¼Œä½ å¯ä»¥æ”¹æˆè‡ªå·±åŸæ¥çš„åŠŸèƒ½
with col3:
    btn_vocab = st.button("ğŸ“– å•è¯çŸ­è¯­è§£æ", type="primary", use_container_width=True)

st.divider()

# -------------------------- 3ä¸ªæŒ‰é’®çš„ç‚¹å‡»é€»è¾‘ï¼Œæ¯ä¸ªå¯¹åº”ç‹¬ç«‹åŠŸèƒ½ --------------------------
# æŒ‰é’®1ç‚¹å‡»äº‹ä»¶ï¼šä¸­è‹±äº’è¯‘
if btn_translate:
    with st.spinner("æ­£åœ¨ç¿»è¯‘ä¸­..."):
        # è¿™é‡Œæ˜¯æŒ‰é’®1å¯¹åº”çš„promptï¼Œæ”¹æˆä½ åŸæ¥çš„åŠŸèƒ½é€»è¾‘å³å¯
        system_prompt = "ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ç¿»è¯‘åŠ©æ‰‹ï¼Œç”¨æˆ·è¾“å…¥ä¸­æ–‡å°±ç¿»è¯‘æˆåœ°é“è‹±è¯­ï¼Œè¾“å…¥è‹±è¯­å°±ç¿»è¯‘æˆé€šé¡ºä¸­æ–‡ï¼Œåªè¿”å›ç¿»è¯‘ç»“æœï¼Œä¸è¦å¤šä½™å†…å®¹ã€‚"
        result = call_minimax_llm(system_prompt, user_input)
        if result:
            st.markdown("### ç¿»è¯‘ç»“æœï¼š")
            st.markdown(result)

# æŒ‰é’®2ç‚¹å‡»äº‹ä»¶ï¼šè¯­æ³•çº é”™+è®²è§£
if btn_grammar:
    with st.spinner("æ­£åœ¨åˆ†æè¯­æ³•ä¸­..."):
        # è¿™é‡Œæ˜¯æŒ‰é’®2å¯¹åº”çš„promptï¼Œæ”¹æˆä½ åŸæ¥çš„åŠŸèƒ½é€»è¾‘å³å¯
        system_prompt = "ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„è‹±è¯­è¯­æ³•è€å¸ˆï¼Œå…ˆçº æ­£ç”¨æˆ·è¾“å…¥è‹±è¯­å¥å­çš„è¯­æ³•é”™è¯¯ï¼Œå†é€å¥è®²è§£è¯­æ³•ç‚¹ï¼Œç”¨é€šä¿—æ˜“æ‡‚çš„ä¸­æ–‡è¯´æ˜ï¼Œç»“æ„æ¸…æ™°ã€‚"
        result = call_minimax_llm(system_prompt, user_input)
        if result:
            st.markdown("### è¯­æ³•çº é”™&è®²è§£ç»“æœï¼š")
            st.markdown(result)

# æŒ‰é’®3ç‚¹å‡»äº‹ä»¶ï¼šå•è¯/çŸ­è¯­è§£æ
if btn_vocab:
    with st.spinner("æ­£åœ¨è§£æè¯æ±‡ä¸­..."):
        # è¿™é‡Œæ˜¯æŒ‰é’®3å¯¹åº”çš„promptï¼Œæ”¹æˆä½ åŸæ¥çš„åŠŸèƒ½é€»è¾‘å³å¯
        system_prompt = "ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„è‹±è¯­è¯æ±‡è€å¸ˆï¼Œè§£æç”¨æˆ·è¾“å…¥çš„è‹±è¯­å•è¯/çŸ­è¯­ï¼Œç»™å‡ºéŸ³æ ‡ã€è¯æ€§ã€ä¸­æ–‡é‡Šä¹‰ã€å¸¸è§æ­é…ã€ä¾‹å¥ï¼Œç”¨ä¸­æ–‡æ•´ç†æˆæ¸…æ™°çš„ç»“æ„ã€‚"
        result = call_minimax_llm(system_prompt, user_input)
        if result:
            st.markdown("### è¯æ±‡è§£æç»“æœï¼š")
            st.markdown(result)
